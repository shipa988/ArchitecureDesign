# 2. architectual-design

Date: 2023-10-29

## Status

Принято

## Context

Основной костяк бекенд разработчиков на бирже - PHP и Go
Фронт-React
Есть DBA
Есть Project-manager, дизайнер, тестировщики

 Разрабатываемая система должна вписываться существующую экосистему биржи, в основе которой лежит EventSourcing и CQRS и 
коммуницировать с внешней системой предпочтительно через шину. Однако внутри проект может быть организован по-другому 
в соответствии с компетенцией команды разработки.
 Согласно основным функциональным и нефункциональным требованиям необходимо разработать безопасную надежную систему управления вкладами 
(контрактами) пользователей. Безопасность управления застейканных (PoS) средствами биржи хранящихся на внешних
кошельках должна является высшим приоритетом. Согласованность и точность при прохождении контрактов по 
состояниям (открыт, отменен, исполнен, средства возвращены, вознаграждение выплачено..) также является высшим приоритетом.

## Decision

Альтернативные решения с оценкой рисков, возможностей

| решение             | риски                                                                                                                                                                                                            | возможности                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **сервисы+1 бд+ES** | тестировать сложнее чем монолит;<br/>выше задержки между подсистемами чем у монолита;<br/>                                                                                                                       | es вписывается в существующую экосистему биржи;<br/>скорость и независимость обновления и развертывания;<br/>легко поддерживать;<br/> 1 бд-без распределенных транзакций,ACID; <br/>возможность параллельной разработки отдельных сервисов;<br/>; мимнимальные задержки между подсистемами;<br/>хорошая масштабируемость подсистем;<br/>высокое ожидание throughput;<br/> недостатки es не влияют на всю систему а только на определенные сервисы |
| монолит+1 бд+ES     | легче интеграционно тестировать;<br/>дольше согласовывать новые релизы;<br/> тяжелее масштабировать;<br/> при росте проекта тежелее сопровождать;<br/> из-за es могут дольше подниматься                         | es вписывается в существующую экосистему биржи;<br/>легко разрабатывать;<br/>быстро деплоить;<br/>быстрее первый релиз;<br/> нет задержек внутри подсистем проекта;<br/>                                                                                                                                                                                                                                                                          |
| монолит+1 бд        | отсутствие es-не вписывается в существующую экосистему биржи;<br/>дольше согласовывать новые релизы;<br/> тяжелее масштабировать;<br/> при росте проекта тежелее сопровождать;<br/>                              | отсутствие es- легче разобраться малокомпетентной или новой команде;<br/>легко разрабатывать;<br/>быстро деплоить;<br/>быстрее первый релиз;<br/> нет задержек внутри подсистем проекта;<br/>быстрее старт<br/>                                                                                                                                                                                                                                   |
| микросервисы+ES     | сложно тестировать;<br/>высокие задержки;<br/>сложнее поддерживать согласованность;<br/>дольше старт сервисов хранящих состояние в памяти но встающих из евентов;<br/> команда должны быть высококвалифицирована | очень быстрая работа отдельных сервисов без пахода в бд;<br/>легко масштабировать;<br/>легко переиписывать и обновлять отдельные микросервисы;<br/>параллельная разработка;<br/> высокий throughput                                                                                                                                                                                                                                               |


Сравнительная оценка альтернатив

| решение             | **итого** | вписывается в экосистему | скорость разработки | latency общ | latency сервиса | throughput | легкость acid | скорость рестарт сервисов | тестирование сервиса | тестирование интегр-е | масштабируемость | команда чел-к | команда квалиф-я | управление | деплой | обновление | новые релизы | поддержка |
|---------------------|-----------|--------------------------|---------------------|-------------|-----------------|------------|---------------|---------------------------|----------------------|-----------------------|------------------|---------------|------------------|------------|--------|------------|--------------|-----------|
| **сервисы+1 бд+ES** | **48**    | 4                        | 2                   | 2           | 3               | 3          | 3             | 3                         | 3                    | 2                     | 3                | 2             | 2                | 2          | 3      | 3          | 3            | 2         |
| монолит+1 бд+ES     | **41**    | 2                        | 3                   | 4           | 2               | 2          | 3             | 2                         | 2                    | 3                     | 2                | 3             | 3                | 3          | 2      | 2          | 2            | 3         |
| монолит+1 бд        | **46**    | 1                        | 4                   | 3           | 1               | 2          | 4             | 4                         | 1                    | 4                     | 1                | 4             | 4                | 4          | 1      | 2          | 2            | 4         |
| микросервисы+ES     | **43**    | 3                        | 1                   | 2           | 4               | 4          | 2             | 1                         | 4                    | 1                     | 4                | 1             | 1                | 1          | 4      | 4          | 4            | 2         |

Согласно выработанным функциональным и нефункцинальным требованиям разработать макеты основных экранов клиентской части и админки.
Управление кошельками (пополнение) производить в ручном режиме 1 администратором с использованием YubiKey (аппаратный ключ
безопасности). Прохождение контракта по состояниям решено реализовать через стейт-машину с использованием транзакционной 
записи состояний в БД mysql- реалиционной бд, широко используюмой в компании. Использовать EventSourcing для получения 
информации о пользователях и их балансах из шины (кафки) биржи. Согласно имеющейся экспертизе, требованиям к безотказной 
работе api, а также тому что система принципиально делится на 2 большие части: обработка внутренних транзакций клиентов
и чтение внешних транзакций о кошельках PoS решено реализовать систему как набор сервисов.
В соответсвии с тем что в компании по части бекенда есть только php и go разработчики, реализацию основных сервисов бекенда
по решено отдать go-команде, реализацию админки - php-команде. Для php выделить 1 разработчика, ревью от тимлида. Go-
2 разработчика с кросс-ревью и финальным ревью тимлида. В соответсвии с макетами разработать моки для апи ответов и параллельно
вести разработку фронта по дизайн макетам и с использованием моков апи. Для фронта выделить 1 человека с ревью тимлида.
Выделить 1 менеджера, 1 тестера подключить на этапе готовности отдельных сервисов.  Мобильную разработку планируется начать
после испытания mvp и фиксации интереса со стороны клиентов. Использование шаблона ВFF (backend for
frontend) сделает реализацию мобильной части быстрой.

## Consequences

Сервисная архитектура принесет в проект гибкость и независимое развертывание и обновление отдельных подсистем проекта.
База данных на проект-mysql.
Выделены следующие сервисы:
 - **api** (открытие-закрытие контрактов/админка) 
 - **distribution**-распределение вознаграждений
 - **scanner**-чтение транзакций блокчейна о состоянии внешних кошельков и запись в шину
 - **rewards**-чтение из шины транзакций от scanner- запись в бд для мониторинга финансовых рисков
 - **usergroups**-чтение из шины биржи информации о кошельках пользователей; разделение пользователей на подгруппы по количеству X-COIN; 
внутреннее api, отдающее группу пользователя для начиления ему привилегий в виде повышенного процента по контракам.

